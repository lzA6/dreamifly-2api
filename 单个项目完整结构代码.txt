é¡¹ç›® 'dreamifly-2api' çš„ç»“æ„æ ‘:
ğŸ“‚ dreamifly-2api/
    ğŸ“„ .env
    ğŸ“„ .env.example
    ğŸ“„ Dockerfile
    ğŸ“„ docker-compose.yml
    ğŸ“„ main.py
    ğŸ“„ nginx.conf
    ğŸ“„ requirements.txt
    ğŸ“‚ app/
        ğŸ“‚ core/
            ğŸ“„ __init__.py
            ğŸ“„ config.py
        ğŸ“‚ providers/
            ğŸ“„ __init__.py
            ğŸ“„ base_provider.py
            ğŸ“„ dreamifly_provider.py
        ğŸ“‚ utils/
            ğŸ“„ sse_utils.py
    ğŸ“‚ static/
        ğŸ“„ index.html
        ğŸ“„ script.js
        ğŸ“„ style.css
================================================================================

--- æ–‡ä»¶è·¯å¾„: .env ---

# [è‡ªåŠ¨å¡«å……] dreamifly-2api ç”Ÿäº§ç¯å¢ƒé…ç½®
# è¯¥æ–‡ä»¶ç”± Genesis Protocol Â· Î© (Omega) ç‰ˆè‡ªåŠ¨ç”Ÿæˆã€‚

# --- å®‰å…¨é…ç½® ---
# ç”¨äºä¿æŠ¤æ‚¨çš„ API æœåŠ¡çš„è®¿é—®å¯†é’¥ï¼Œè¯·æŒ‰éœ€ä¿®æ”¹ä¸ºæ‚¨è‡ªå·±çš„å¤æ‚å¯†é’¥ã€‚
API_MASTER_KEY=1

# --- ç«¯å£é…ç½® ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088

# --- Dreamifly.com å‡­è¯ ---
# å·²ä»æ‚¨æä¾›çš„æŠ“åŒ…æ•°æ®ä¸­è‡ªåŠ¨æå–ã€‚
DREAMIFLY_AUTH_TOKEN="Bearer 251016"



--- æ–‡ä»¶è·¯å¾„: .env.example ---

# ====================================================================
# dreamifly-2api é…ç½®æ–‡ä»¶æ¨¡æ¿
# ====================================================================
#
# è¯·å°†æ­¤æ–‡ä»¶é‡å‘½åä¸º ".env" å¹¶å¡«å…¥æ‚¨çš„å‡­è¯ã€‚
#

# --- æ ¸å¿ƒå®‰å…¨é…ç½® (å¿…é¡»è®¾ç½®) ---
# ç”¨äºä¿æŠ¤æ‚¨ API æœåŠ¡çš„è®¿é—®å¯†é’¥ã€‚
API_MASTER_KEY=sk-dreamifly-2api-default-key-please-change-me

# --- éƒ¨ç½²é…ç½® (å¯é€‰) ---
# Nginx å¯¹å¤–æš´éœ²çš„ç«¯å£
NGINX_PORT=8088

# --- Dreamifly.com å‡­è¯ (å¿…é¡»è®¾ç½®) ---
# è¯·ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è·å–ã€‚
DREAMIFLY_AUTH_TOKEN="Bearer 251016"



--- æ–‡ä»¶è·¯å¾„: Dockerfile ---

# /Dockerfile
FROM python:3.10-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

COPY . .

RUN useradd --create-home appuser && \
    chown -R appuser:appuser /app
USER appuser

EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "1"]


--- æ–‡ä»¶è·¯å¾„: docker-compose.yml ---

# /docker-compose.yml
services:
  nginx:
    image: nginx:latest
    container_name: dreamifly-2api-nginx
    restart: always
    ports:
      - "${NGINX_PORT:-8088}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app
    networks:
      - dreamifly-net

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dreamifly-2api-app
    restart: unless-stopped
    env_file:
      - .env
    networks:
      - dreamifly-net

networks:
  dreamifly-net:
    driver: bridge


--- æ–‡ä»¶è·¯å¾„: main.py ---

import logging
from contextlib import asynccontextmanager
from typing import Optional

from fastapi import FastAPI, Request, HTTPException, Depends, Header, File, UploadFile, Form
from fastapi.responses import JSONResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles

from app.core.config import settings
from app.providers.dreamifly_provider import DreamiflyProvider

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

provider = DreamiflyProvider()

@asynccontextmanager
async def lifespan(app: FastAPI):
    logger.info(f"åº”ç”¨å¯åŠ¨ä¸­... {settings.APP_NAME} v{settings.APP_VERSION}")
    logger.info(f"æœåŠ¡å°†åœ¨ http://localhost:{settings.NGINX_PORT} ä¸Šå¯ç”¨")
    logger.info(f"Web UI æµ‹è¯•ç•Œé¢å·²å¯ç”¨ï¼Œè¯·è®¿é—® http://localhost:{settings.NGINX_PORT}/")
    yield
    logger.info("åº”ç”¨å…³é—­ã€‚")

app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description=settings.DESCRIPTION,
    lifespan=lifespan
)

app.mount("/static", StaticFiles(directory="static"), name="static")

async def verify_api_key(authorization: Optional[str] = Header(None)):
    if settings.API_MASTER_KEY and settings.API_MASTER_KEY != "1":
        if not authorization or "bearer" not in authorization.lower():
            raise HTTPException(status_code=401, detail="éœ€è¦ Bearer Token è®¤è¯ã€‚")
        token = authorization.split(" ")[-1]
        if token != settings.API_MASTER_KEY:
            raise HTTPException(status_code=403, detail="æ— æ•ˆçš„ API Keyã€‚")

@app.post("/v1/images/generations", dependencies=[Depends(verify_api_key)])
async def image_generations(request: Request):
    """å¤„ç†æ–‡ç”Ÿå›¾è¯·æ±‚"""
    try:
        request_data = await request.json()
        return await provider.generate_image(request_data)
    except Exception as e:
        logger.error(f"å¤„ç†æ–‡ç”Ÿå›¾è¯·æ±‚æ—¶å‡ºé”™: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")

@app.post("/v1/images/edits", dependencies=[Depends(verify_api_key)])
async def image_edits(
    image: UploadFile = File(...),
    prompt: str = Form(...),
    model: Optional[str] = Form(None),
    style: Optional[str] = Form("æ— "),
    n: Optional[int] = Form(1),
    size: Optional[str] = Form("1024x1024"),
    steps: Optional[int] = Form(20)
):
    """å¤„ç†å›¾ç”Ÿå›¾è¯·æ±‚"""
    try:
        image_bytes = await image.read()
        request_data = {
            "prompt": prompt,
            "model": model,
            "style": style,
            "n": n,
            "size": size,
            "steps": steps
        }
        return await provider.generate_image(request_data, image_bytes=image_bytes)
    except Exception as e:
        logger.error(f"å¤„ç†å›¾ç”Ÿå›¾è¯·æ±‚æ—¶å‡ºé”™: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"å†…éƒ¨æœåŠ¡å™¨é”™è¯¯: {str(e)}")

@app.get("/v1/models", dependencies=[Depends(verify_api_key)])
async def list_models():
    return await provider.get_models()

@app.get("/v1/styles", dependencies=[Depends(verify_api_key)])
async def list_styles():
    return JSONResponse(content={"data": list(settings.STYLE_MAPPING.keys())})

@app.get("/", response_class=HTMLResponse, include_in_schema=False)
async def serve_ui():
    try:
        with open("static/index.html", "r", encoding="utf-8") as f:
            return HTMLResponse(content=f.read())
    except FileNotFoundError:
        raise HTTPException(status_code=404, detail="UI æ–‡ä»¶ (static/index.html) æœªæ‰¾åˆ°ã€‚")


--- æ–‡ä»¶è·¯å¾„: nginx.conf ---

# /nginx.conf
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    upstream dreamifly_backend {
        # ip_hash is not strictly necessary for this stateless service,
        # but it's a good practice for potential future stateful features.
        ip_hash;
        server app:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # Allow larger request bodies for image uploads
        client_max_body_size 50M;

        location / {
            proxy_pass http://dreamifly_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_http_version 1.1;
            chunked_transfer_encoding off;
        }
    }
}


--- æ–‡ä»¶è·¯å¾„: requirements.txt ---

fastapi
uvicorn[standard]
pydantic-settings
python-dotenv
cloudscraper
python-multipart
aiohttp


--- æ–‡ä»¶è·¯å¾„: app\core\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\core\config.py ---

from pydantic_settings import BaseSettings, SettingsConfigDict
from typing import Optional, List, Dict, Any

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding='utf-8',
        extra="ignore"
    )

    APP_NAME: str = "dreamifly-2api"
    APP_VERSION: str = "1.0.0"
    DESCRIPTION: str = "ä¸€ä¸ªå°† dreamifly.com å›¾åƒç”ŸæˆåŠŸèƒ½è½¬æ¢ä¸ºå…¼å®¹ OpenAI æ ¼å¼ API çš„é«˜æ€§èƒ½ä»£ç†ã€‚"

    API_MASTER_KEY: Optional[str] = None
    DREAMIFLY_AUTH_TOKEN: Optional[str] = None

    # --- ä¿®æ”¹ç‚¹ 1: å»¶é•¿è¯·æ±‚è¶…æ—¶æ—¶é—´ ---
    # å°†è¶…æ—¶æ—¶é—´ä» 300 ç§’å¢åŠ åˆ° 600 ç§’ (10 åˆ†é’Ÿ)
    API_REQUEST_TIMEOUT: int = 600

    # --- æ–°å¢ç‚¹: ä¸Šæ¸¸ API å¹¶å‘é™åˆ¶ ---
    # æ ¹æ®æ‚¨çš„åé¦ˆï¼Œè®¾ç½®ä¸º 2
    UPSTREAM_CONCURRENCY_LIMIT: int = 2

    NGINX_PORT: int = 8088

    # æ¨¡å‹é…ç½®
    # å®šä¹‰äº†æ‰€æœ‰å¯ç”¨çš„æ¨¡å‹åŠå…¶å¯¹åº”çš„ä¸Šæ¸¸åç§°
    MODEL_MAPPING: Dict[str, str] = {
        "dreamifly-qwen-image": "Qwen-Image",
        "dreamifly-qwen-edit": "Qwen-Image-Edit",
        "dreamifly-flux-dev": "Flux-Dev",
        "dreamifly-flux-krea": "Flux-Krea",
        "dreamifly-flux-kontext": "Flux-Kontext",
        "dreamifly-sdxl": "Wai-SDXL-V150",
    }
    DEFAULT_MODEL: str = "dreamifly-qwen-image"

    # é£æ ¼é…ç½®
    # å®šä¹‰äº†æ‰€æœ‰å¯ç”¨çš„é£æ ¼åŠå…¶å¯¹åº”çš„æç¤ºè¯å‰ç¼€
    STYLE_MAPPING: Dict[str, str] = {
        "æ— ": "",
        "å¡é€š": "cartoon style, ",
        "åŠ¨æ¼«": "anime style, ",
        "æ²¹ç”»": "oil painting style, ",
        "çº¿ç¨¿": "line art style, ",
        "çŸ¢é‡çº¿æ¡": "vector line style, ",
        "è¡—æœºåƒç´ ": "pixel art style, ",
        "ä¹é«˜ç§¯æœ¨": "lego style, ",
        "Risoå™ªç‚¹æ’ç”»": "risograph style, ",
        "ç°å®é£æ ¼": "realistic style, ",
        "å¸ƒå¶é£æ ¼": "puppet style, ",
        "Emojiå›¾æ ‡é£æ ¼": "emoji icon style, ",
    }

settings = Settings()


--- æ–‡ä»¶è·¯å¾„: app\providers\__init__.py ---



--- æ–‡ä»¶è·¯å¾„: app\providers\base_provider.py ---

from abc import ABC, abstractmethod
from typing import Dict, Any, Optional
from fastapi.responses import JSONResponse

class BaseProvider(ABC):
    @abstractmethod
    async def generate_image(self, request_data: Dict[str, Any], image_bytes: Optional[bytes] = None) -> JSONResponse:
        pass

    @abstractmethod
    async def get_models(self) -> JSONResponse:
        pass


--- æ–‡ä»¶è·¯å¾„: app\providers\dreamifly_provider.py ---

import time
import logging
import random
import asyncio
import base64
import json
from typing import Dict, Any, Optional, Tuple

import cloudscraper
from fastapi import HTTPException
from fastapi.responses import JSONResponse

from app.core.config import settings
from app.providers.base_provider import BaseProvider

logger = logging.getLogger(__name__)

class DreamiflyProvider(BaseProvider):
    BASE_URL = "https://dreamifly.com/api/generate"

    def __init__(self):
        # --- ä¿®æ”¹ç‚¹ 2: åˆå§‹åŒ–å¹¶å‘æ§åˆ¶å™¨ (Semaphore) ---
        # ä½¿ç”¨åœ¨ config.py ä¸­å®šä¹‰çš„å€¼ (2)
        self.semaphore = asyncio.Semaphore(settings.UPSTREAM_CONCURRENCY_LIMIT)
        logger.info(f"å¹¶å‘æ§åˆ¶å™¨å·²åˆå§‹åŒ–ï¼Œæœ€å¤§å¹¶å‘æ•°: {settings.UPSTREAM_CONCURRENCY_LIMIT}")

    def _prepare_headers(self) -> Dict[str, str]:
        if not settings.DREAMIFLY_AUTH_TOKEN:
            raise ValueError("DREAMIFLY_AUTH_TOKEN æœªåœ¨ .env æ–‡ä»¶ä¸­é…ç½®ã€‚")
        return {
            "Accept": "*/*",
            "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
            "Authorization": settings.DREAMIFLY_AUTH_TOKEN,
            "Content-Type": "application/json",
            "Origin": "https://dreamifly.com",
            "Referer": "https://dreamifly.com/zh",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36"
        }

    def _parse_size(self, size: Optional[str]) -> Tuple[int, int]:
        if not size or 'x' not in size:
            return 1024, 1024
        try:
            width, height = map(int, size.split('x'))
            return width, height
        except (ValueError, TypeError):
            logger.warning(f"æ— æ•ˆçš„ size å‚æ•°: '{size}', ä½¿ç”¨é»˜è®¤å€¼ 1024x1024")
            return 1024, 1024

    async def _send_single_request(self, payload: Dict[str, Any], task_id: int) -> str:
        # ä¿æŒæ¯ä¸ªè¯·æ±‚åˆ›å»ºç‹¬ç«‹ scraper å®ä¾‹ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨
        scraper = cloudscraper.create_scraper(
            browser={'browser': 'chrome', 'platform': 'windows', 'mobile': False}
        )
        
        loop = asyncio.get_running_loop()
        headers = self._prepare_headers()
        
        logger.info(f"[ä»»åŠ¡ {task_id}] æ­£åœ¨å‘ä¸Šæ¸¸å‘é€è¯·æ±‚, Prompt: '{str(payload.get('prompt'))[:50]}...'")
        
        response = None
        try:
            response = await loop.run_in_executor(
                None, 
                lambda: scraper.post(
                    self.BASE_URL,
                    headers=headers,
                    json=payload,
                    timeout=settings.API_REQUEST_TIMEOUT
                )
            )
            
            logger.info(f"[ä»»åŠ¡ {task_id}] æ”¶åˆ°ä¸Šæ¸¸å“åº”çŠ¶æ€ç : {response.status_code}")
            response.raise_for_status()
            
            content_type = response.headers.get("Content-Type", "")
            
            if "application/json" in content_type:
                response_json = response.json()
                image_url = response_json.get("imageUrl")
                if not image_url or not image_url.startswith("data:image/png;base64,"):
                    raise ValueError(f"ä¸Šæ¸¸ API è¿”å›çš„ JSON ä¸­æœªåŒ…å«æœ‰æ•ˆçš„ Base64 å›¾åƒæ•°æ®ã€‚")
                logger.info(f"[ä»»åŠ¡ {task_id}] æˆåŠŸè·å–å›¾åƒæ•°æ®ã€‚")
                return image_url.split(',', 1)[1]
            
            else:
                raise ValueError(f"ä¸Šæ¸¸è¿”å›äº†éé¢„æœŸçš„ Content-Type: {content_type}ã€‚å¯èƒ½æ˜¯è¢« Cloudflare æ‹¦æˆªã€‚")

        except Exception as e:
            error_message = f"[ä»»åŠ¡ {task_id}] è¯·æ±‚ä¸Šæ¸¸å¤±è´¥: {e}"
            if response is not None:
                error_message += f"\nä¸Šæ¸¸å“åº”å†…å®¹ (Raw Text):\n---START---\n{response.text[:1000]}\n---END---"
            logger.error(error_message, exc_info=True)
            raise

    async def generate_image(self, request_data: Dict[str, Any], image_bytes: Optional[bytes] = None) -> JSONResponse:
        prompt = request_data.get("prompt")
        if not prompt:
            raise HTTPException(status_code=400, detail="å‚æ•° 'prompt' ä¸èƒ½ä¸ºç©ºã€‚")

        user_model = request_data.get("model", settings.DEFAULT_MODEL)
        actual_model = settings.MODEL_MAPPING.get(user_model)
        if not actual_model:
            raise HTTPException(status_code=400, detail=f"ä¸æ”¯æŒçš„æ¨¡å‹: '{user_model}'")

        style_key = request_data.get("style", "æ— ")
        style_prefix = settings.STYLE_MAPPING.get(style_key, "")
        final_prompt = f"{style_prefix}{prompt}"

        width, height = self._parse_size(request_data.get("size"))
        num_images = request_data.get("n", 1)
        steps = request_data.get("steps", 20)

        base_payload = {
            "prompt": final_prompt,
            "width": width,
            "height": height,
            "steps": steps,
            "batch_size": 1,
            "model": actual_model,
        }

        if image_bytes:
            base64_image = base64.b64encode(image_bytes).decode('utf-8')
            base_payload["images"] = [f"data:image/png;base64,{base64_image}"]
            if "edit" not in actual_model.lower():
                 logger.warning(f"æ­£åœ¨ä½¿ç”¨å‚è€ƒå›¾ï¼Œä½†é€‰æ‹©çš„æ¨¡å‹ '{actual_model}' å¯èƒ½ä¸æ˜¯ä¸€ä¸ªç¼–è¾‘æ¨¡å‹ã€‚")
        else:
            base_payload["images"] = []

        # --- ä¿®æ”¹ç‚¹ 3: ä½¿ç”¨å¹¶å‘æ§åˆ¶å™¨åŒ…è£…ä»»åŠ¡ ---
        async def controlled_task_runner(payload: Dict[str, Any], task_id: int):
            """ä¸€ä¸ªåŒ…è£…å™¨ï¼Œå®ƒä¼šå…ˆè·å–ä¿¡å·é‡ï¼Œå†æ‰§è¡Œä»»åŠ¡"""
            async with self.semaphore:
                logger.info(f"[ä»»åŠ¡ {task_id}] è·å–åˆ°ä¿¡å·é‡ï¼Œå¼€å§‹æ‰§è¡Œã€‚")
                result = await self._send_single_request(payload, task_id)
                logger.info(f"[ä»»åŠ¡ {task_id}] æ‰§è¡Œå®Œæ¯•ï¼Œé‡Šæ”¾ä¿¡å·é‡ã€‚")
                return result

        tasks = []
        for i in range(num_images):
            payload = base_payload.copy()
            payload["seed"] = random.randint(0, 100_000_000)
            # åˆ›å»ºè¢«å¹¶å‘æ§åˆ¶å™¨åŒ…è£…åçš„ä»»åŠ¡
            tasks.append(controlled_task_runner(payload, task_id=i + 1))
        
        logger.info(f"å·²åˆ›å»º {num_images} ä¸ªä»»åŠ¡ï¼Œå‡†å¤‡é€šè¿‡å¹¶å‘æ§åˆ¶å™¨ï¼ˆä¸Šé™ {settings.UPSTREAM_CONCURRENCY_LIMIT}ï¼‰æ‰§è¡Œ...")

        try:
            # asyncio.gather ä¼šå¹¶å‘è¿è¡Œæ‰€æœ‰ä»»åŠ¡ï¼Œä½† semaphore ä¼šç¡®ä¿åŒæ—¶è¿›è¡Œçš„ç½‘ç»œè¯·æ±‚ä¸è¶…è¿‡é™åˆ¶
            results = await asyncio.gather(*tasks, return_exceptions=True)
            
            successful_results = []
            exceptions = []
            for i, res in enumerate(results):
                if isinstance(res, Exception):
                    logger.error(f"[ä»»åŠ¡ {i + 1}] æœ€ç»ˆæ‰§è¡Œå¤±è´¥: {res}")
                    exceptions.append(f"ä»»åŠ¡ {i+1}: {res}")
                else:
                    successful_results.append({"b64_json": res})
            
            if not successful_results:
                error_details = "; ".join(exceptions)
                raise HTTPException(status_code=502, detail=f"æ‰€æœ‰ä¸Šæ¸¸å›¾åƒç”Ÿæˆä»»åŠ¡å‡å¤±è´¥ã€‚é”™è¯¯è¯¦æƒ…: {error_details}")

            return JSONResponse(content={
                "created": int(time.time()),
                "data": successful_results
            })

        except Exception as e:
            if isinstance(e, HTTPException):
                raise e
            logger.error(f"å¤„ç†å¹¶å‘è¯·æ±‚æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}", exc_info=True)
            raise HTTPException(status_code=502, detail=f"ä¸Šæ¸¸æœåŠ¡é”™è¯¯æˆ–æ‰€æœ‰é‡è¯•å‡å¤±è´¥: {str(e)}")

    async def get_models(self) -> JSONResponse:
        return JSONResponse(content={
            "object": "list",
            "data": [
                {"id": name, "object": "model", "created": int(time.time()), "owned_by": "lzA6"}
                for name in settings.MODEL_MAPPING.keys()
            ]
        })


--- æ–‡ä»¶è·¯å¾„: app\utils\sse_utils.py ---

import json
import time
from typing import Dict, Any, Optional

DONE_CHUNK = b"data: [DONE]\n\n"

def create_sse_data(data: Dict[str, Any]) -> bytes:
    """å°†å­—å…¸æ•°æ®æ ¼å¼åŒ–ä¸º SSE äº‹ä»¶å­—ç¬¦ä¸²ã€‚"""
    return f"data: {json.dumps(data, ensure_ascii=False)}\n\n".encode('utf-8')

def create_chat_completion_chunk(
    request_id: str,
    model: str,
    content: str,
    finish_reason: Optional[str] = None
) -> Dict[str, Any]:
    """åˆ›å»ºä¸€ä¸ªä¸ OpenAI å…¼å®¹çš„èŠå¤©è¡¥å…¨æµå¼å—ã€‚"""
    return {
        "id": request_id,
        "object": "chat.completion.chunk",
        "created": int(time.time()),
        "model": model,
        "choices": [
            {
                "index": 0,
                "delta": {"content": content},
                "finish_reason": finish_reason
            }
        ]
    }


--- æ–‡ä»¶è·¯å¾„: static\index.html ---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamifly-2API é«˜çº§æµ‹è¯•é¢æ¿</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h2>Dreamifly-2API</h2>
                <p>v1.0 - é«˜çº§æµ‹è¯•é¢æ¿</p>
            </div>

            <div class="form-group">
                <label for="api-key">API Key</label>
                <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key" value="1">
            </div>

            <div class="form-group">
                <label for="model-select">æ¨¡å‹ (Model)</label>
                <select id="model-select"></select>
            </div>

            <div class="form-group">
                <label for="style-select">é£æ ¼ (Style)</label>
                <select id="style-select"></select>
            </div>

            <div class="form-group">
                <label>å‚è€ƒå›¾ (å¯é€‰)</label>
                <div id="image-preview-container" class="image-drop-zone">
                    <img id="image-preview" src="#" alt="å›¾ç‰‡é¢„è§ˆ" class="hidden">
                    <span id="upload-placeholder">ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</span>
                    <button id="clear-image-btn" class="hidden">&times;</button>
                </div>
                <input type="file" id="image-upload" accept="image/*" class="hidden">
            </div>

            <div class="form-group">
                <label for="prompt-input">æç¤ºè¯ (Prompt)</label>
                <textarea id="prompt-input" rows="6" placeholder="è¾“å…¥æ‚¨çš„å›¾åƒæè¿°..."></textarea>
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="width-slider">å®½åº¦ (Width)</label>
                    <span id="width-value">1024px</span>
                </div>
                <input type="range" id="width-slider" min="256" max="2048" step="8" value="1024">
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="height-slider">é«˜åº¦ (Height)</label>
                    <span id="height-value">1024px</span>
                </div>
                <input type="range" id="height-slider" min="256" max="2048" step="8" value="1024">
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="steps-slider">æ­¥æ•° (Steps)</label>
                    <span id="steps-value">20</span>
                </div>
                <input type="range" id="steps-slider" min="10" max="32" step="1" value="20">
            </div>

            <div class="form-group slider-group">
                <div class="slider-label">
                    <label for="count-slider">ç”Ÿæˆæ•°é‡ (Count)</label>
                    <span id="count-value">1</span>
                </div>
                <input type="range" id="count-slider" min="1" max="8" step="1" value="1">
            </div>

            <button id="generate-btn">
                <span>ç”Ÿæˆå›¾åƒ</span>
            </button>
        </div>
        <div class="main-content">
            <div id="result-panel">
                <div id="placeholder" class="placeholder">
                    <p>è¯·åœ¨å·¦ä¾§é…ç½®å‚æ•°å¹¶å¼€å§‹ç”Ÿæˆ</p>
                </div>
                <div id="spinner" class="spinner hidden"></div>
                <div id="error-message" class="error hidden"></div>
                <div id="image-grid"></div>
            </div>
        </div>
    </div>
    <script src="/static/script.js"></script>
</body>
</html>

--- æ–‡ä»¶è·¯å¾„: static\script.js ---

document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const apiKeyInput = document.getElementById('api-key');
    const modelSelect = document.getElementById('model-select');
    const styleSelect = document.getElementById('style-select');
    const imageUpload = document.getElementById('image-upload');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const uploadPlaceholder = document.getElementById('upload-placeholder');
    const clearImageBtn = document.getElementById('clear-image-btn');
    const promptInput = document.getElementById('prompt-input');
    const generateBtn = document.getElementById('generate-btn');
    
    const widthSlider = document.getElementById('width-slider');
    const widthValue = document.getElementById('width-value');
    const heightSlider = document.getElementById('height-slider');
    const heightValue = document.getElementById('height-value');
    const stepsSlider = document.getElementById('steps-slider');
    const stepsValue = document.getElementById('steps-value');
    const countSlider = document.getElementById('count-slider');
    const countValue = document.getElementById('count-value');

    const imageGrid = document.getElementById('image-grid');
    const spinner = document.getElementById('spinner');
    const errorMessage = document.getElementById('error-message');
    const placeholder = document.getElementById('placeholder');

    let selectedFile = null;

    // --- Core Functions ---

    async function fetchAndPopulate(endpoint, selectElement, placeholderText) {
        selectElement.innerHTML = `<option>${placeholderText}...</option>`;
        selectElement.disabled = true;
        
        try {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) throw new Error("API Key is missing.");

            const response = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${apiKey}` } });
            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || `Failed to load data from ${endpoint}`);
            
            selectElement.innerHTML = '';
            result.data.forEach(item => {
                const option = document.createElement('option');
                const value = typeof item === 'object' ? item.id : item;
                option.value = value;
                option.textContent = value;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
            return true;
        } catch (error) {
            selectElement.innerHTML = `<option>åŠ è½½å¤±è´¥</option>`;
            showError(`åŠ è½½å¤±è´¥: ${error.message}`);
            return false;
        }
    }

    async function loadInitialData() {
        generateBtn.disabled = true;
        const modelsLoaded = await fetchAndPopulate('/v1/models', modelSelect, 'åŠ è½½æ¨¡å‹ä¸­');
        const stylesLoaded = await fetchAndPopulate('/v1/styles', styleSelect, 'åŠ è½½é£æ ¼ä¸­');
        if (modelsLoaded && stylesLoaded) {
            generateBtn.disabled = false;
        }
    }

    function handleFile(file) {
        if (!file) return;
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = e => {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove('hidden');
            uploadPlaceholder.classList.add('hidden');
            clearImageBtn.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function clearImage() {
        selectedFile = null;
        imageUpload.value = '';
        imagePreview.src = '#';
        imagePreview.classList.add('hidden');
        uploadPlaceholder.classList.remove('hidden');
        clearImageBtn.classList.add('hidden');
    }

    async function handleGenerate() {
        const apiKey = apiKeyInput.value.trim();
        const prompt = promptInput.value.trim();
        if (!apiKey || !prompt) {
            showError("è¯·ç¡®ä¿ API Key å’Œæç¤ºè¯éƒ½å·²å¡«å†™ã€‚");
            return;
        }

        setLoading(true);

        try {
            let response;
            if (selectedFile) {
                // å›¾ç”Ÿå›¾
                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('prompt', prompt);
                formData.append('model', modelSelect.value);
                formData.append('style', styleSelect.value);
                formData.append('n', countSlider.value);
                formData.append('size', `${widthSlider.value}x${heightSlider.value}`);
                formData.append('steps', stepsSlider.value);
                
                response = await fetch('/v1/images/edits', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}` },
                    body: formData
                });
            } else {
                // æ–‡ç”Ÿå›¾
                const payload = {
                    prompt: prompt,
                    model: modelSelect.value,
                    style: styleSelect.value,
                    n: parseInt(countSlider.value, 10),
                    size: `${widthSlider.value}x${heightSlider.value}`,
                    steps: parseInt(stepsSlider.value, 10),
                    response_format: "b64_json"
                };
                response = await fetch('/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });
            }

            const result = await response.json();
            if (!response.ok) throw new Error(result.detail || 'ç”Ÿæˆå¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯ã€‚');

            if (result.data && result.data.length > 0) {
                displayImages(result.data);
            } else {
                throw new Error('API è¿”å›äº†æˆåŠŸçŠ¶æ€ï¼Œä½†æ²¡æœ‰å›¾ç‰‡æ•°æ®ã€‚');
            }
        } catch (error) {
            showError(error.message);
        } finally {
            setLoading(false);
        }
    }

    function displayImages(data) {
        imageGrid.innerHTML = '';
        data.forEach(item => {
            if (item.b64_json) {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container';
                const img = document.createElement('img');
                img.src = `data:image/png;base64,${item.b64_json}`;
                img.alt = 'Generated Image';
                imgContainer.appendChild(img);
                imageGrid.appendChild(imgContainer);
            }
        });
    }

    function setLoading(isLoading) {
        generateBtn.disabled = isLoading;
        spinner.classList.toggle('hidden', !isLoading);
        placeholder.classList.toggle('hidden', isLoading || imageGrid.children.length > 0);
        if (isLoading) {
            imageGrid.innerHTML = '';
            hideError();
        }
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
        placeholder.classList.add('hidden');
    }

    function hideError() {
        errorMessage.classList.add('hidden');
    }

    // --- Event Listeners ---
    apiKeyInput.addEventListener('change', loadInitialData);
    imagePreviewContainer.addEventListener('click', () => imageUpload.click());
    imagePreviewContainer.addEventListener('dragover', e => e.preventDefault());
    imagePreviewContainer.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
    imageUpload.addEventListener('change', e => handleFile(e.target.files[0]));
    clearImageBtn.addEventListener('click', (e) => { e.stopPropagation(); clearImage(); });
    
    widthSlider.addEventListener('input', () => widthValue.textContent = `${widthSlider.value}px`);
    heightSlider.addEventListener('input', () => heightValue.textContent = `${heightSlider.value}px`);
    stepsSlider.addEventListener('input', () => stepsValue.textContent = stepsSlider.value);
    countSlider.addEventListener('input', () => countValue.textContent = countSlider.value);

    generateBtn.addEventListener('click', handleGenerate);

    // --- Initial Load ---
    loadInitialData();
});


--- æ–‡ä»¶è·¯å¾„: static\style.css ---

:root {
    --bg-color: #f0f2f5;
    --sidebar-bg: #ffffff;
    --main-bg: #f7f7f8;
    --border-color: #e5e7eb;
    --text-color: #111827;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --input-bg: #f9fafb;
}

* { box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    margin: 0;
    background-color: var(--bg-color);
    color: var(--text-color);
    font-size: 14px;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

.container { display: flex; width: 100%; height: 100%; }

.sidebar {
    width: 380px;
    flex-shrink: 0;
    background-color: var(--sidebar-bg);
    border-right: 1px solid var(--border-color);
    padding: 24px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
}

.header { padding-bottom: 16px; margin-bottom: 24px; border-bottom: 1px solid var(--border-color); }
.header h2 { margin: 0; }
.header p { margin: 4px 0 0; color: var(--text-secondary); }

.main-content { flex-grow: 1; background-color: var(--main-bg); padding: 24px; overflow-y: auto; }
#result-panel { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }

.form-group { margin-bottom: 16px; }
label { display: block; font-weight: 500; margin-bottom: 8px; }

input[type="password"], textarea, select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 14px;
    background-color: var(--input-bg);
    transition: border-color 0.2s;
}
textarea { resize: vertical; }
input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
}

.image-drop-zone {
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
    background-color: var(--input-bg);
    transition: border-color 0.2s;
}
.image-drop-zone:hover { border-color: var(--primary-color); }
#image-preview { max-width: 100%; max-height: 100%; object-fit: contain; }
#upload-placeholder { color: var(--text-secondary); text-align: center; }
#clear-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 16px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
}

.slider-group .slider-label { display: flex; justify-content: space-between; align-items: center; }
.slider-group .slider-label span { font-weight: 600; color: var(--primary-color); }
.slider-group small { display: block; margin-top: 6px; font-size: 12px; color: var(--text-secondary); }

input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: #ddd; border-radius: 5px; outline: none; margin-top: 8px; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--primary-color); cursor: pointer; border-radius: 50%; }
input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; background: var(--primary-color); cursor: pointer; border-radius: 50%; }

#generate-btn {
    width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none;
    border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
    display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: auto;
}
#generate-btn:hover { background-color: var(--primary-hover); }
#generate-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }

.placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--text-secondary); }
#image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(256px, 1fr)); gap: 16px; width: 100%; }
.image-container { position: relative; overflow: hidden; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.image-container img { width: 100%; height: 100%; object-fit: cover; display: block; }

.hidden { display: none; }
.spinner { border: 5px solid rgba(0, 0, 0, 0.1); width: 50px; height: 50px; border-radius: 50%; border-left-color: var(--primary-color); animation: spin 1s ease infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.error { color: #b91c1c; background-color: #fee2e2; border: 1px solid #fca5a5; padding: 15px; border-radius: 6px; text-align: center; max-width: 80%; }



